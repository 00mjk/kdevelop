#!/bin/sh
# This is a RPM build script that will generate RPMS and SRPMS from a kdevelop source
# dist and a spec file generated by KPP.
# If you have any problems please contact geiseri@yahoo.com

NAME=$1
VERSION=$2
SOURCE=$3
BASE=$4
error ()
{
	echo #### RPM BUILD ERROR ####
	exit 0
}

good ()
{
	echo #### RPMS HAVE BEEN BUILT ####
	exit 1
}

DIR=$BASE/build-$NAME


        rm -rf $DIR
        echo Starting Build Process
        mkdir -p $DIR/RPMROOT/BUILD/   || error
        mkdir -p $DIR/RPMROOT/RPMS/    || error
        mkdir -p $DIR/RPMROOT/SOURCES/ || error
        mkdir -p $DIR/RPMROOT/SPECS/   || error
        mkdir -p $DIR/RPMROOT/SRPMS/   || error
        mkdir -p $DIR/RPMROOT/tmp/     || error
        mkdir -p $DIR/$NAME-$VERSION   || error

        cp -a $SOURCE $DIR/RPMROOT/SOURCES                || error
        cp -a $BASE/$NAME.spec $DIR/RPMROOT/SPECS         || error
        if [ $BASE/$NAME/lo32-app-$NAME.png]; then
                convert $BASE/$NAME/lo32-app-$NAME.png $DIR/RPMROOT/SOURCES/$NAME.xpm       || error
        fi
cat > $DIR/rpmmacros <<EOF
%_topdir $DIR/RPMROOT/
%_tmppath $DIR/RPMROOT/tmp/
EOF

cat > $DIR/rpmrc <<EOF
macrofiles: /usr/lib/rpm/macros:/usr/lib/rpm/%{_target}/macros:/etc/rpm/macros:/etc/rpm/%{_target}/macros:~/.rpmmacros:$DIR/rpmmacros
EOF

        rpm -ba $DIR/RPMROOT/SPECS/$NAME.spec --rcfile $DIR/rpmrc               || error
        mkdir -p $BASE/upload                                                   || error
        cp -a $DIR/RPMROOT/SOURCES/* $DIR/RPMROOT/SRPMS/* $DIR/RPMROOT/RPMS/*/* $BASE || error
        rm -rf $DIR                                                             || error
        echo FINISHED
        good
