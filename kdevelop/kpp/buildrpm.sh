#!/bin/sh
# This is a RPM build script that will generate RPMS and SRPMS from a kdevelop source
# dist and a spec file generated by KPP.
# If you have any problems please contact geiseri@yahoo.com

NAME=$1
VERSION=$2
SOURCE=$3
DIR=~/.kde/build-$NAME
BASE=$PWD

        rm -rf $DIR
        echo Starting Build Process
        mkdir -p $DIR/RPMROOT/BUILD/   || exit 0
        mkdir -p $DIR/RPMROOT/RPMS/    || exit 0
        mkdir -p $DIR/RPMROOT/SOURCES/ || exit 0
        mkdir -p $DIR/RPMROOT/SPECS/   || exit 0
        mkdir -p $DIR/RPMROOT/SRPMS/   || exit 0
        mkdir -p $DIR/RPMROOT/tmp/     || exit 0
        mkdir -p $DIR/$NAME-$VERSION   || exit 0

        cp -a $SOURCE/$NAME-$VERSION.tar.gz $DIR/RPMROOT/SOURCES                || exit 0
        cp -a $SOURCE/$NAME.spec $DIR/RPMROOT/SPECS                             || exit 0
        convert $SOURCE/$NAME/lo32-app-$NAME.png $DIR/RPMROOT/SOURCES/$NAME.xpm       || exit 0

cat > $DIR/rpmmacros <<EOF
%_topdir $DIR/RPMROOT/
%_tmppath $DIR/RPMROOT/tmp/
EOF

cat > $DIR/rpmrc <<EOF
macrofiles: /usr/lib/rpm/macros:/usr/lib/rpm/%{_target}/macros:/etc/rpm/macros:/etc/rpm/%{_target}/macros:~/.rpmmacros:$DIR/rpmmacros
EOF

        rpm -ba $DIR/RPMROOT/SPECS/$NAME.spec --rcfile $DIR/rpmrc               || exit 0
        mkdir -p $BASE/upload                                                   || exit 0
        cp -a $DIR/RPMROOT/SOURCES/* $DIR/RPMROOT/SRPMS/* $DIR/RPMROOT/RPMS/*/* $BASE || exit 0
        rm -rf $DIR                                                             || exit 0
        echo FINISHED
        exit 1