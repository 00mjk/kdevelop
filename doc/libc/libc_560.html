<HTML>
<HEAD>
<!-- This HTML file has been created by texi2html 1.51
     from libc.texinfo on 28 March 2001 -->

<TITLE>The GNU C Library - Enable/Disable Setuid</TITLE>
</HEAD>
<BODY>
Go to the <A HREF="libc_1.html">first</A>, <A HREF="libc_559.html">previous</A>, <A HREF="libc_561.html">next</A>, <A HREF="libc_654.html">last</A> section, <A HREF="libc_toc.html">table of contents</A>.
<P><HR><P>


<H2><A NAME="SEC568" HREF="libc_toc.html#TOC568">Enabling and Disabling Setuid Access</A></H2>

<P>
A typical setuid program does not need its special access all of the
time.  It's a good idea to turn off this access when it isn't needed,
so it can't possibly give unintended access.

</P>
<P>
If the system supports the <CODE>_POSIX_SAVED_IDS</CODE> feature, you can
accomplish this with <CODE>seteuid</CODE>.  When the game program starts, its
real user ID is <CODE>jdoe</CODE>, its effective user ID is <CODE>games</CODE>, and
its saved user ID is also <CODE>games</CODE>.  The program should record both
user ID values once at the beginning, like this:

</P>

<PRE>
user_user_id = getuid ();
game_user_id = geteuid ();
</PRE>

<P>
Then it can turn off game file access with

</P>

<PRE>
seteuid (user_user_id);
</PRE>

<P>
and turn it on with

</P>

<PRE>
seteuid (game_user_id);
</PRE>

<P>
Throughout this process, the real user ID remains <CODE>jdoe</CODE> and the
file user ID remains <CODE>games</CODE>, so the program can always set its
effective user ID to either one.

</P>
<P>
On other systems that don't support file user IDs, you can
turn setuid access on and off by using <CODE>setreuid</CODE> to swap the real
and effective user IDs of the process, as follows:

</P>

<PRE>
setreuid (geteuid (), getuid ());
</PRE>

<P>
This special case is always allowed--it cannot fail.

</P>
<P>
Why does this have the effect of toggling the setuid access?  Suppose a
game program has just started, and its real user ID is <CODE>jdoe</CODE> while
its effective user ID is <CODE>games</CODE>.  In this state, the game can
write the scores file.  If it swaps the two uids, the real becomes
<CODE>games</CODE> and the effective becomes <CODE>jdoe</CODE>; now the program has
only <CODE>jdoe</CODE> access.  Another swap brings <CODE>games</CODE> back to
the effective user ID and restores access to the scores file.

</P>
<P>
In order to handle both kinds of systems, test for the saved user ID
feature with a preprocessor conditional, like this:

</P>

<PRE>
#ifdef _POSIX_SAVED_IDS
  setuid (user_user_id);
#else
  setreuid (geteuid (), getuid ());
#endif
</PRE>

<P><HR><P>
Go to the <A HREF="libc_1.html">first</A>, <A HREF="libc_559.html">previous</A>, <A HREF="libc_561.html">next</A>, <A HREF="libc_654.html">last</A> section, <A HREF="libc_toc.html">table of contents</A>.
</BODY>
</HTML>
