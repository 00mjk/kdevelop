<HTML>
<HEAD>
<!-- This HTML file has been created by texi2html 1.51
     from libc.texinfo on 28 March 2001 -->

<TITLE>The GNU C Library - Non-atomic Example</TITLE>
</HEAD>
<BODY>
Go to the <A HREF="libc_1.html">first</A>, <A HREF="libc_445.html">previous</A>, <A HREF="libc_447.html">next</A>, <A HREF="libc_654.html">last</A> section, <A HREF="libc_toc.html">table of contents</A>.
<P><HR><P>


<H4><A NAME="SEC453" HREF="libc_toc.html#TOC453">Problems with Non-Atomic Access</A></H4>

<P>
Here is an example which shows what can happen if a signal handler runs
in the middle of modifying a variable.  (Interrupting the reading of a
variable can also lead to paradoxical results, but here we only show
writing.)

</P>

<PRE>
#include &#60;signal.h&#62;
#include &#60;stdio.h&#62;

struct two_words { int a, b; } memory;

void
handler(int signum)
{
   printf ("%d,%d\n", memory.a, memory.b);
   alarm (1);
}

int
main (void)
{
   static struct two_words zeros = { 0, 0 }, ones = { 1, 1 };
   signal (SIGALRM, handler);
   memory = zeros;
   alarm (1);
   while (1)
     {
       memory = zeros;
       memory = ones;
     }
}
</PRE>

<P>
This program fills <CODE>memory</CODE> with zeros, ones, zeros, ones,
alternating forever; meanwhile, once per second, the alarm signal handler
prints the current contents.  (Calling <CODE>printf</CODE> in the handler is
safe in this program because it is certainly not being called outside
the handler when the signal happens.)

</P>
<P>
Clearly, this program can print a pair of zeros or a pair of ones.  But
that's not all it can do!  On most machines, it takes several
instructions to store a new value in <CODE>memory</CODE>, and the value is
stored one word at a time.  If the signal is delivered in between these
instructions, the handler might find that <CODE>memory.a</CODE> is zero and
<CODE>memory.b</CODE> is one (or vice versa).

</P>
<P>
On some machines it may be possible to store a new value in
<CODE>memory</CODE> with just one instruction that cannot be interrupted.  On
these machines, the handler will always print two zeros or two ones.

</P>
<P><HR><P>
Go to the <A HREF="libc_1.html">first</A>, <A HREF="libc_445.html">previous</A>, <A HREF="libc_447.html">next</A>, <A HREF="libc_654.html">last</A> section, <A HREF="libc_toc.html">table of contents</A>.
</BODY>
</HTML>
