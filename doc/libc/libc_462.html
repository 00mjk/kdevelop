<HTML>
<HEAD>
<!-- This HTML file has been created by texi2html 1.51
     from libc.texinfo on 28 March 2001 -->

<TITLE>The GNU C Library - Remembering a Signal</TITLE>
</HEAD>
<BODY>
Go to the <A HREF="libc_1.html">first</A>, <A HREF="libc_461.html">previous</A>, <A HREF="libc_463.html">next</A>, <A HREF="libc_654.html">last</A> section, <A HREF="libc_toc.html">table of contents</A>.
<P><HR><P>


<H3><A NAME="SEC469" HREF="libc_toc.html#TOC469">Remembering a Signal to Act On Later</A></H3>

<P>
Instead of blocking a signal using the library facilities, you can get
almost the same results by making the handler set a flag to be tested
later, when you "unblock".  Here is an example:

</P>

<PRE>
/* If this flag is nonzero, don't handle the signal right away. */
volatile sig_atomic_t signal_pending;

/* This is nonzero if a signal arrived and was not handled. */
volatile sig_atomic_t defer_signal;

void
handler (int signum)
{
  if (defer_signal)
    signal_pending = signum;
  else
    ... /* "Really" handle the signal. */
}

...

void
update_mumble (int frob)
{
  /* Prevent signals from having immediate effect. */
  defer_signal++;
  /* Now update <CODE>mumble</CODE>, without worrying about interruption. */
  mumble.a = 1;
  mumble.b = hack ();
  mumble.c = frob;
  /* We have updated <CODE>mumble</CODE>.  Handle any signal that came in. */
  defer_signal--;
  if (defer_signal == 0 &#38;&#38; signal_pending != 0)
    raise (signal_pending);
}
</PRE>

<P>
Note how the particular signal that arrives is stored in
<CODE>signal_pending</CODE>.  That way, we can handle several types of
inconvenient signals with the same mechanism.

</P>
<P>
We increment and decrement <CODE>defer_signal</CODE> so that nested critical
sections will work properly; thus, if <CODE>update_mumble</CODE> were called
with <CODE>signal_pending</CODE> already nonzero, signals would be deferred
not only within <CODE>update_mumble</CODE>, but also within the caller.  This
is also why we do not check <CODE>signal_pending</CODE> if <CODE>defer_signal</CODE>
is still nonzero.

</P>
<P>
The incrementing and decrementing of <CODE>defer_signal</CODE> require more
than one instruction; it is possible for a signal to happen in the
middle.  But that does not cause any problem.  If the signal happens
early enough to see the value from before the increment or decrement,
that is equivalent to a signal which came before the beginning of the
increment or decrement, which is a case that works properly.

</P>
<P>
It is absolutely vital to decrement <CODE>defer_signal</CODE> before testing
<CODE>signal_pending</CODE>, because this avoids a subtle bug.  If we did
these things in the other order, like this,

</P>

<PRE>
  if (defer_signal == 1 &#38;&#38; signal_pending != 0)
    raise (signal_pending);
  defer_signal--;
</PRE>

<P>
then a signal arriving in between the <CODE>if</CODE> statement and the decrement
would be effectively "lost" for an indefinite amount of time.  The
handler would merely set <CODE>defer_signal</CODE>, but the program having
already tested this variable, it would not test the variable again.

</P>
<P>
<A NAME="IDX2591"></A>
Bugs like these are called <STRONG>timing errors</STRONG>.  They are especially bad
because they happen only rarely and are nearly impossible to reproduce.
You can't expect to find them with a debugger as you would find a
reproducible bug.  So it is worth being especially careful to avoid
them.

</P>
<P>
(You would not be tempted to write the code in this order, given the use
of <CODE>defer_signal</CODE> as a counter which must be tested along with
<CODE>signal_pending</CODE>.  After all, testing for zero is cleaner than
testing for one.  But if you did not use <CODE>defer_signal</CODE> as a
counter, and gave it values of zero and one only, then either order
might seem equally simple.  This is a further advantage of using a
counter for <CODE>defer_signal</CODE>: it will reduce the chance you will
write the code in the wrong order and create a subtle bug.)

</P>
<P><HR><P>
Go to the <A HREF="libc_1.html">first</A>, <A HREF="libc_461.html">previous</A>, <A HREF="libc_463.html">next</A>, <A HREF="libc_654.html">last</A> section, <A HREF="libc_toc.html">table of contents</A>.
</BODY>
</HTML>
