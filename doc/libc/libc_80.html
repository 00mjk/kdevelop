<HTML>
<HEAD>
<!-- This HTML file has been created by texi2html 1.51
     from libc.texinfo on 28 March 2001 -->

<TITLE>The GNU C Library - Selecting the Conversion</TITLE>
</HEAD>
<BODY>
Go to the <A HREF="libc_1.html">first</A>, <A HREF="libc_79.html">previous</A>, <A HREF="libc_81.html">next</A>, <A HREF="libc_654.html">last</A> section, <A HREF="libc_toc.html">table of contents</A>.
<P><HR><P>


<H3><A NAME="SEC80" HREF="libc_toc.html#TOC80">Selecting the conversion and its properties</A></H3>

<P>
We already said above that the currently selected locale for the
<CODE>LC_CTYPE</CODE> category decides about the conversion which is performed
by the functions we are about to describe.  Each locale uses its own
character set (given as an argument to <CODE>localedef</CODE>) and this is the
one assumed as the external multibyte encoding.  The wide character
character set always is UCS4, at least on GNU systems.

</P>
<P>
A characteristic of each multibyte character set is the maximum number
of bytes which can be necessary to represent one character.  This
information is quite important when writing code which uses the
conversion functions.  In the examples below we will see some examples.
The ISO C standard defines two macros which provide this information.

</P>

<P>
<DL>
<DT><U>Macro:</U> int <B>MB_LEN_MAX</B>
<DD><A NAME="IDX524"></A>
This macro specifies the maximum number of bytes in the multibyte
sequence for a single character in any of the supported locales.  It is
a compile-time constant and it is defined in <TT>`limits.h'</TT>.
<A NAME="IDX525"></A>
</DL>

</P>
<P>
<DL>
<DT><U>Macro:</U> int <B>MB_CUR_MAX</B>
<DD><A NAME="IDX526"></A>
<CODE>MB_CUR_MAX</CODE> expands into a positive integer expression that is the
maximum number of bytes in a multibyte character in the current locale.
The value is never greater than <CODE>MB_LEN_MAX</CODE>.  Unlike
<CODE>MB_LEN_MAX</CODE> this macro need not be a compile-time constant and in
fact, in the GNU C library it is not.

</P>
<P>
<A NAME="IDX527"></A>
<CODE>MB_CUR_MAX</CODE> is defined in <TT>`stdlib.h'</TT>.
</DL>

</P>
<P>
Two different macros are necessary since strictly ISO C89 compilers
do not allow variable length array definitions but still it is desirable
to avoid dynamic allocation.  This incomplete piece of code shows the
problem:

</P>

<PRE>
{
  char buf[MB_LEN_MAX];
  ssize_t len = 0;

  while (! feof (fp))
    {
      fread (&#38;buf[len], 1, MB_CUR_MAX - len, fp);
      /* ... process buf */
      len -= used;
    }
}
</PRE>

<P>
The code in the inner loop is expected to have always enough bytes in
the array <VAR>buf</VAR> to convert one multibyte character.  The array
<VAR>buf</VAR> has to be sized statically since many compilers do not allow a
variable size.  The <CODE>fread</CODE> call makes sure that always
<CODE>MB_CUR_MAX</CODE> bytes are available in <VAR>buf</VAR>.  Note that it isn't
a problem if <CODE>MB_CUR_MAX</CODE> is not a compile-time constant.

</P>

<P><HR><P>
Go to the <A HREF="libc_1.html">first</A>, <A HREF="libc_79.html">previous</A>, <A HREF="libc_81.html">next</A>, <A HREF="libc_654.html">last</A> section, <A HREF="libc_toc.html">table of contents</A>.
</BODY>
</HTML>
