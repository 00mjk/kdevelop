<HTML>
<HEAD>
<!-- This HTML file has been created by texi2html 1.51
     from libc.texinfo on 28 March 2001 -->

<TITLE>The GNU C Library - NSS Module Function Internals</TITLE>
</HEAD>
<BODY>
Go to the <A HREF="libc_1.html">first</A>, <A HREF="libc_550.html">previous</A>, <A HREF="libc_552.html">next</A>, <A HREF="libc_654.html">last</A> section, <A HREF="libc_toc.html">table of contents</A>.
<P><HR><P>


<H3><A NAME="SEC559" HREF="libc_toc.html#TOC559">Internals of the NSS Module Functions</A></H3>

<P>
Until now we only provided the syntactic interface for the functions in
the NSS module.  In fact there is not more much we can tell since the
implementation obviously is different for each function.  But a few
general rules must be followed by all functions.

</P>
<P>
In fact there are four kinds of different functions which may appear in
the interface.  All derive from the traditional ones for system databases.
<VAR>db</VAR> in the following table is normally an abbreviation for the
database (e.g., it is <CODE>pw</CODE> for the password database).

</P>
<DL COMPACT>

<DT><CODE>enum nss_status _nss_<VAR>database</VAR>_set<VAR>db</VAR>ent (void)</CODE>
<DD>
This function prepares the service for following operations.  For a
simple file based lookup this means files could be opened, for other
services this function simply is a noop.

One special case for this function is that it takes an additional
argument for some <VAR>database</VAR>s (i.e., the interface is
<CODE>int set<VAR>db</VAR>ent (int)</CODE>).  section <A HREF="libc_296.html#SEC303">Host Names</A>, which describes the
<CODE>sethostent</CODE> function.

The return value should be <VAR>NSS_STATUS_SUCCESS</VAR> or according to the
table above in case of an error (see section <A HREF="libc_548.html#SEC556">The Interface of the Function in NSS Modules</A>).

<DT><CODE>enum nss_status _nss_<VAR>database</VAR>_end<VAR>db</VAR>ent (void)</CODE>
<DD>
This function simply closes all files which are still open or removes
buffer caches.  If there are no files or buffers to remove this is again
a simple noop.

There normally is no return value different to <VAR>NSS_STATUS_SUCCESS</VAR>.

<DT><CODE>enum nss_status _nss_<VAR>database</VAR>_get<VAR>db</VAR>ent_r (<VAR>STRUCTURE</VAR> *result, char *buffer, size_t buflen, int *errnop)</CODE>
<DD>
Since this function will be called several times in a row to retrieve
one entry after the other it must keep some kind of state.  But this
also means the functions are not really reentrant.  They are reentrant
only in that simultaneous calls to this function will not try to
write the retrieved data in the same place (as it would be the case for
the non-reentrant functions); instead, it writes to the structure
pointed to by the <VAR>result</VAR> parameter.  But the calls share a common
state and in the case of a file access this means they return neighboring
entries in the file.

The buffer of length <VAR>buflen</VAR> pointed to by <VAR>buffer</VAR> can be used
for storing some additional data for the result.  It is <EM>not</EM>
guaranteed that the same buffer will be passed for the next call of this
function.  Therefore one must not misuse this buffer to save some state
information from one call to another.

Before the function returns the implementation should store the value of
the local <VAR>errno</VAR> variable in the variable pointed to be
<VAR>errnop</VAR>.  This is important to guarantee the module working in
statically linked programs.

As explained above this function could also have an additional last
argument.  This depends on the database used; it happens only for
<CODE>host</CODE> and <CODE>networks</CODE>.

The function shall return <CODE>NSS_STATUS_SUCCESS</CODE> as long as their are
more entries.  When the last entry was read it should return
<CODE>NSS_STATUS_NOTFOUND</CODE>.  When the buffer given as an argument is too
small for the data to be returned <CODE>NSS_STATUS_TRYAGAIN</CODE> should be
returned.  When the service was not formerly initialized by a call to
<CODE>_nss_<VAR>DATABASE</VAR>_set<VAR>db</VAR>ent</CODE> all return value allowed for
this function can also be returned here.

<DT><CODE>enum nss_status _nss_<VAR>DATABASE</VAR>_get<VAR>db</VAR>by<VAR>XX</VAR>_r (<VAR>PARAMS</VAR>, <VAR>STRUCTURE</VAR> *result, char *buffer, size_t buflen, int *errnop)</CODE>
<DD>
This function shall return the entry from the database which is
addressed by the <VAR>PARAMS</VAR>.  The type and number of these arguments
vary.  It must be individually determined by looking to the user-level
interface functions.  All arguments given to the non-reentrant version
are here described by <VAR>PARAMS</VAR>.

The result must be stored in the structure pointed to by <VAR>result</VAR>.
If there is additional data to return (say strings, where the
<VAR>result</VAR> structure only contains pointers) the function must use the
<VAR>buffer</VAR> or length <VAR>buflen</VAR>.  There must not be any references
to non-constant global data.

The implementation of this function should honour the <VAR>stayopen</VAR>
flag set by the <CODE>set<VAR>DB</VAR>ent</CODE> function whenever this makes sense.

Before the function returns the implementation should store the value of
the local <VAR>errno</VAR> variable in the variable pointed to be
<VAR>errnop</VAR>.  This is important to guarantee the module working in
statically linked programs.

Again, this function takes an additional last argument for the
<CODE>host</CODE> and <CODE>networks</CODE> database.

The return value should as always follow the rules given above
(see section <A HREF="libc_548.html#SEC556">The Interface of the Function in NSS Modules</A>).

</DL>
<P><HR><P>
Go to the <A HREF="libc_1.html">first</A>, <A HREF="libc_550.html">previous</A>, <A HREF="libc_552.html">next</A>, <A HREF="libc_654.html">last</A> section, <A HREF="libc_toc.html">table of contents</A>.
</BODY>
</HTML>
