<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML
><HEAD
><TITLE
>Network Transparency</TITLE
><META
NAME="GENERATOR"
CONTENT="Modular DocBook HTML Stylesheet Version 1.54"/><LINK
REL="HOME"
TITLE="KDE 2.0 Development"
HREF="index.html"/><LINK
REL="UP"
TITLE="KDE Style Reference"
HREF="ch06.html"/><LINK
REL="PREVIOUS"
TITLE="Executing Other Programs"
HREF="ch06lev1sec7.html"/><LINK
REL="NEXT"
TITLE="User Friendliness"
HREF="ch06lev1sec9.html"/><META
HTTP-EQUIV="Content-Style-Type"
CONTENT="text/css"/><LINK
REL="stylesheet"
HREF="kde-common.css"
TYPE="text/css"/><META
HTTP-EQUIV="Content-Type"
CONTENT="text/html; charset=iso-8859-1"/><META
HTTP-EQUIV="Content-Language"
CONTENT="en"/><LINK
REL="stylesheet"
HREF="kde-localised.css"
TYPE="text/css"
TITLE="KDE-English"/><LINK
REL="stylesheet"
HREF="kde-default.css"
TYPE="text/css"
TITLE="KDE-Default"/></HEAD
><BODY
CLASS="section"
LINK="#336699"
VLINK="#336699"
ALINK="#336699"
BGCOLOR="#FFFFFF"
><DIV
ALIGN="RIGHT"
CLASS="NAVBAR"
><P
><A
HREF="ch06lev1sec7.html"
>Prev</A
> <A
HREF="ch06lev1sec9.html"
>Next</A
> <A
HREF="index.html"
>Table of Contents</A
></P
></DIV
><DIV
CLASS="section"
><TABLE
WIDTH="100%"
CELLPADDING="0"
CELLSPACING="0"
BORDER="0"
ALIGN="CENTER"
><TR
><TD
WIDTH="90%"
><H1
CLASS="section"
><A
NAME="ch06lev1sec8"
>6.8. Network Transparency</A
></H1
><P
>If you want a program to be able to have the KDE sticker, it needs to be network transparent. Fortunately, this isn't all that difficult! The importance of such a functionality cannot be understated; more information on network transparency is also presented in <A
HREF="ch07.html"
>Chapter 7, <SPAN
CLASS="QUOTE"
>"Further KDE Compliance."</SPAN
></A
></P
><P
>Generally, the only two classes that need to be worried about are <TT
CLASS="literal"
>KIO::Job</TT
> and <TT
CLASS="literal"
>KIO::NetAccess</TT
>. <TT
CLASS="literal"
>KIO</TT
> is a namespace.</P
><P
>Remember that KDE would rather deal with URLs than with filenames. Both can be stored in a <TT
CLASS="literal"
>QString</TT
>, but you should prefer a <TT
CLASS="literal"
>KURL</TT
>, because it can do all the parsing for you.</P
><P
>In the following example (<A
HREF="ch06lev1sec8.html#ch06list08"
>Listing 6.8</A
>), the user has clicked the Open toolbar or menu item. The Open File window appears, and then the selected file opens.</P
><P
>You'll have to include kfiledialog.h, netaccess.h, and knotifyclient.h.</P
><DIV
CLASS="example"
><HR/><A
NAME="ch06list08"
></A
><P
><B
>Example 6.8. Opening a File, Network Transparently</B
></P
><TABLE
BORDER="0"
BGCOLOR="#E0E0E0"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="programlisting"
>   1&nbsp;
   2&nbsp; 1: // In this class, we have declared a QString file, which is the filename
   3&nbsp; 2: // of the local copy of our file. We also have a KURL url which contains
   4&nbsp; 3: // the local/remote location of the file that is opened
   5&nbsp; 4:
   6&nbsp; 5: // TODO: Test if there is already a file open, or, if the current file
   7&nbsp; 6: // has been edited
   8&nbsp; 7:
   9&nbsp; 8: url=KFileDialog::getOpenURL(0,
  10&nbsp; 9:     "*.txt|Text Files (*.txt)\n*.cpp|C++ Source Files (*.cpp)",this);
  11&nbsp;10:
  12&nbsp;11: if (!KIO::NetAccess::download(url, file))
  13&nbsp;12:     KNotifyClient::event("cannotopenfile"), return;
  14&nbsp;13:
  15&nbsp;14: // That's it! Now, we get to open the string "local" the standard way
  16&nbsp;15:
  17&nbsp;16: QFile f(file);
  18&nbsp;17: // TODO: read and open the file&#8230;.
  19&nbsp;</PRE
></TD
></TR
></TABLE
><HR/></DIV
><P
>When the user clicks Save, you want to store the file to the server, if necessary:</P
><DIV
CLASS="informalexample"
><HR/><TABLE
BORDER="0"
BGCOLOR="#E0E0E0"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="programlisting"
>   1&nbsp;
   2&nbsp;// file and url have been declared, remember?
   3&nbsp;QFile f(file);
   4&nbsp;// [&#8230;] store data to file
   5&nbsp;f.close();
   6&nbsp;
   7&nbsp;if (!KIO::NetAccess::upload(file, url))
   8&nbsp;    KNotifyClient::event("cannotopenfile"), return;
   9&nbsp;</PRE
></TD
></TR
></TABLE
><HR/></DIV
><P
>Not that bad at all, is it?</P
><P
>What if the user has not selected a filename for this file yet? <A
HREF="ch06lev1sec8.html#ch06list09"
>Listing 6.9</A
> shows what to do in such a situation:</P
><DIV
CLASS="example"
><HR/><A
NAME="ch06list09"
></A
><P
><B
>Example 6.9. More Network Transparency Checks</B
></P
><TABLE
BORDER="0"
BGCOLOR="#E0E0E0"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="programlisting"
>   1&nbsp;
   2&nbsp; 1: if (url.isEmpty())
   3&nbsp; 2: {
   4&nbsp; 3:   url=KFileDialog::getSaveUrl(0,
   5&nbsp; 4:   "*.txt|Text Files (*.txt)\n*.cpp|C++ Source (*.cpp)", this)
   6&nbsp; 5:   // URL now contains where we want to save this to
   7&nbsp; 6:     file=url.path();
   8&nbsp; 7:   // This won't be useful if it's not a local file, but if it is a local  file
   9&nbsp; 8:   // we get to save directly into this!
  10&nbsp; 9:   if (!file.isLocalPath())
  11&nbsp;10:   // We must come up with a temporary file to save to (more info on this  shortly)
  12&nbsp;11:
  13&nbsp;12: [&#8230;]
  14&nbsp;</PRE
></TD
></TR
></TABLE
><HR/></DIV
><P
>Your application should have two menu items: Save and Save As.</P
><P
>Save As asks you to save a file in another filename and format. Save just saves it under the currently selected filename; if that filename has not been selected, Save acts as Save As.</P
><P
><A
HREF="ch06lev1sec8.html#ch06list10"
>Listing 6.10</A
> is the full and complete code of those two methods; you should often be able to just plug this in with minimal changes. Just remember that <TT
CLASS="literal"
>KURL url</TT
> and <TT
CLASS="literal"
>QString file</TT
> have been declared.</P
><DIV
CLASS="example"
><HR/><A
NAME="ch06list10"
></A
><P
><B
>Example 6.10. Complete Network Transparency Example</B
></P
><TABLE
BORDER="0"
BGCOLOR="#E0E0E0"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="programlisting"
>   1&nbsp;
   2&nbsp; 1: #include &lt;ktempfile.h&gt;
   3&nbsp; 2:
   4&nbsp; 3: void MainWindow::slotSaveAs()
   5&nbsp; 4: {
   6&nbsp; 5:   url=KFileDialog::getSaveUrl(0,
   7&nbsp; 6:   "*.txt|Text Files (*.txt)\n*.cpp|C++ Source (*.cpp)",
   8&nbsp; 7:     this)
   9&nbsp; 8:   file=url.path();
  10&nbsp; 9:
  11&nbsp;10:   if (!file.isLocalPath())
  12&nbsp;11:   {
  13&nbsp;12:     KTempFile temp;
  14&nbsp;13:     file=temp.name(); // Get somewhere local to write to
  15&nbsp;14:
  16&nbsp;15:     slotSave(); // write to that
  17&nbsp;16:     temp.unlink();
  18&nbsp;17:     return;
  19&nbsp;18:   }
  20&nbsp;19:   // As of here, the url will always be local, which means
  21&nbsp;20:   // that file contains the local path of the file to save!
  22&nbsp;21:   // So lets just save it!
  23&nbsp;22:   slotSave();
  24&nbsp;23: }
  25&nbsp;24:
  26&nbsp;25: void MainWindow::slotSave()
  27&nbsp;26: {
  28&nbsp;27:   // Looks like there isn't a selected file yet!
  29&nbsp;28:   if (url.isEmpty() || file.isEmpty())
  30&nbsp;29:     slotSaveAs(), return;
  31&nbsp;30:
  32&nbsp;31:   // Lets save the file.
  33&nbsp;32:   QFile f(file);
  34&nbsp;33:
  35&nbsp;34:   // IO_Truncate purges the file so we start with a
  36&nbsp;35:   // clean slate
  37&nbsp;36:   if (!f.open(IO_WriteOnly | IO_Truncate))
  38&nbsp;37:     KNotifyClient::event("cannotopenfile"), return;
  39&nbsp;38:
  40&nbsp;39:   QTextStream t( &amp;f );
  41&nbsp;40:   // QDataStream may be more appropriate for some
  42&nbsp;41:   // purposes, check the QT documentation for all your
  43&nbsp;42:   // file-storing needs.
  44&nbsp;43:   t &lt;&lt; "The filename that was stored is " &lt;&lt; file &lt;&lt; '\n';
  45&nbsp;44:
  46&nbsp;45:   f.close();
  47&nbsp;46:
  48&nbsp;47:   // TODO: Set a flag, telling you that this file is
  49&nbsp;48:   // currently saved.
  50&nbsp;49: }
  51&nbsp;50:
  52&nbsp;51: void MainWindow::slotOpen()
  53&nbsp;52: {
  54&nbsp;53:   if ( /* TODO: test if the currently opened file needs to be saved */ )
  55&nbsp;54:   { // User already has a file open! What does this
  56&nbsp;55:     // person want to do with this file?
  57&nbsp;56:     int result=KMessageBox::questionYesNo(this,
  58&nbsp;57:        i18n("You already have a file open! Would you"
  59&nbsp;58:             "like to save the currently "
  60&nbsp;59:             "opened file and open another?"),
  61&nbsp;60:        i18n("Continue?"));
  62&nbsp;61:
  63&nbsp;62:    if (result==KMessageBox::Yes)
  64&nbsp;63:      slotSave();
  65&nbsp;64:    else
  66&nbsp;65:      return;
  67&nbsp;66:   }
  68&nbsp;67:
  69&nbsp;68:   url=KFileDialog::getOpenURL(0,
  70&nbsp;69:     "*.txt|Text Files (*.txt)\n*.cpp|C++ Source(*.cpp)",
  71&nbsp;70:     this);
  72&nbsp;71:
  73&nbsp;72:   if (!KIO::NetAccess::download(url, file))
  74&nbsp;73:     KNotifyClient::event("cannotopenfile"), return;
  75&nbsp;74:
  76&nbsp;75:   QFile f(file);
  77&nbsp;76:   if (!f.open(IO_ReadOnly))
  78&nbsp;77:     KNotifyClient::event("cannotopenfile"), return;
  79&nbsp;78:
  80&nbsp;79:   QTextStream t( &amp;f );
  81&nbsp;80:   QString dataFromFile;
  82&nbsp;81:   t&gt;&gt;dataFromFile;
  83&nbsp;82:   // TODO: Do something with the data!
  84&nbsp;83:
  85&nbsp;84:   f.close();
  86&nbsp;85: }
  87&nbsp;</PRE
></TD
></TR
></TABLE
><HR/></DIV
></TD
><TD
WIDTH="10%"
VALIGN="BOTTOM"
ALIGN="CENTER"
><ANNMARK
NAME="ch06lev1sec8"/></TD
></TR
><ANNOTATION
NAME="ch06lev1sec8"
TITLE="Network Transparency"/></TABLE
></DIV
><DIV
ALIGN="RIGHT"
CLASS="NAVBAR"
><P
><A
HREF="ch06lev1sec7.html"
>Prev</A
> <A
HREF="ch06lev1sec9.html"
>Next</A
> <A
HREF="index.html"
>Table of Contents</A
></P
></DIV
><HR
WIDTH="100%"
SIZE="2"
ALIGN="CENTER"
NOSHADE="NOSHADE"/></BODY
></HTML
>