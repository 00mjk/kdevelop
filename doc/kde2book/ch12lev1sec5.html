<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML
><HEAD
><TITLE
>Creating a Part</TITLE
><META
NAME="GENERATOR"
CONTENT="Modular DocBook HTML Stylesheet Version 1.54"/><LINK
REL="HOME"
TITLE="KDE 2.0 Development"
HREF="index.html"/><LINK
REL="UP"
TITLE="Creating and Using Components (KParts)"
HREF="ch12.html"/><LINK
REL="PREVIOUS"
TITLE="Read-Only and Read/Write Parts"
HREF="ch12lev1sec4.html"/><LINK
REL="NEXT"
TITLE="Making a Part Available Using Shared Libraries"
HREF="ch12lev1sec6.html"/><META
HTTP-EQUIV="Content-Style-Type"
CONTENT="text/css"/><LINK
REL="stylesheet"
HREF="kde-common.css"
TYPE="text/css"/><META
HTTP-EQUIV="Content-Type"
CONTENT="text/html; charset=iso-8859-1"/><META
HTTP-EQUIV="Content-Language"
CONTENT="en"/><LINK
REL="stylesheet"
HREF="kde-localised.css"
TYPE="text/css"
TITLE="KDE-English"/><LINK
REL="stylesheet"
HREF="kde-default.css"
TYPE="text/css"
TITLE="KDE-Default"/></HEAD
><BODY
CLASS="section"
LINK="#336699"
VLINK="#336699"
ALINK="#336699"
BGCOLOR="#FFFFFF"
><DIV
ALIGN="RIGHT"
CLASS="NAVBAR"
><P
><A
HREF="ch12lev1sec4.html"
>Prev</A
> <A
HREF="ch12lev1sec6.html"
>Next</A
> <A
HREF="index.html"
>Table of Contents</A
></P
></DIV
><DIV
CLASS="section"
><TABLE
WIDTH="100%"
CELLPADDING="0"
CELLSPACING="0"
BORDER="0"
ALIGN="CENTER"
><TR
><TD
WIDTH="90%"
><H1
CLASS="section"
><A
NAME="ch12lev1sec5"
>12.5. Creating a Part</A
></H1
><P
>In 
			
			this section, you create a very simple part for a text editor. If you have closely followed the previous section, you know that the part should inherit <TT
CLASS="literal"
>KParts::ReadWritePart</TT
>.</P
><P
>At this point, it is a very good idea to read kparts/part.h, directly or preferably after running kdoc on it (see <A
HREF="ch15.html"
>Chapter 15, <SPAN
CLASS="QUOTE"
>"Creating Documentation,"</SPAN
>
			</A
> for information about kdoc). This tells you that a read/write part implementation has to provide the methods <TT
CLASS="literal"
>openFile()</TT
> and <TT
CLASS="literal"
>saveFile()</TT
>.
			
			
		</P
><P
>The task of <TT
CLASS="literal"
>openFile()
				
			</TT
> is obviously to open a local file, which the framework has previously downloaded for us in case the URL that the user wants to open is a remote one. In this case, the file you open is a temporary local file.</P
><P
>In <TT
CLASS="literal"
>saveFile()</TT
>, 
			the part saves to the local file, and in case it's a temporary file, the framework takes care of uploading the new file.</P
><P
>You can now sketch the header file for your part, which is called <TT
CLASS="literal"
>NotepadPart</TT
> (see <A
HREF="ch12lev1sec5.html#ch12list02"
>Listing 12.2</A
>).
			
			
			
			
		</P
><DIV
CLASS="example"
><HR/><A
NAME="ch12list02"
></A
><P
><B
>Example 12.2. notepad_part.h: Header of the NotepadPart Class
			</B
></P
><TABLE
BORDER="0"
BGCOLOR="#E0E0E0"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="programlisting"
>   1&nbsp;
   2&nbsp; 1: #ifndef __notepad_h__
   3&nbsp; 2: #define __notepad_h__
   4&nbsp; 3:
   5&nbsp; 4: #include &lt;kparts/part.h&gt;
   6&nbsp; 5:
   7&nbsp; 6: class QMultiLineEdit;
   8&nbsp; 7:
   9&nbsp; 8: class NotepadPart : public KParts::ReadWritePart
  10&nbsp; 9: {
  11&nbsp;10:   Q_OBJECT
  12&nbsp;11: public:
  13&nbsp;12:   NotepadPart( QWidget * parent, const char * name = 0L );
  14&nbsp;13:   virtual ~NotepadPart() {}
  15&nbsp;14:
  16&nbsp;15:   virtual void setReadWrite( bool rw );
  17&nbsp;16:
  18&nbsp;17: protected:
  19&nbsp;18:   virtual bool openFile();
  20&nbsp;19:   virtual bool saveFile();
  21&nbsp;20:
  22&nbsp;21: protected slots:
  23&nbsp;22:   void slotSelectAll();
  24&nbsp;23:
  25&nbsp;24: protected:
  26&nbsp;25:   QMultiLineEdit * m_edit;
  27&nbsp;26:   KInstance *m_instance;
  28&nbsp;27: };
  29&nbsp;28:
  30&nbsp;29: #endif
  31&nbsp;			</PRE
></TD
></TR
></TABLE
><HR/></DIV
><P
>The parent passed to the constructor is both the parent of the widget and the parent of the part itself, so that both get destroyed if the parent is destroyed. Note that having the same parent is not mandatory. If they have different parents, the framework deletes the widget if the part is destroyed and deletes the part if the widget is destroyed.
			
			
			
		</P
><P
>The class members are a <TT
CLASS="literal"
>QMultiLineEdit</TT
> (the multiline widget from Qt), and a <TT
CLASS="literal"
>KInstance</TT
>. An instance enables access to global KDE objects, which can be different from the ones of the application. The application's configuration file and the one of any other instance is different, as well as the search paths for <TT
CLASS="literal"
>locate()</TT
>, and so on. In KParts, this is used to locate the XML file describing the part, which is usually installed into share/apps/instancename/.</P
><P
>In addition, you define a slot, <TT
CLASS="literal"
>slotSelectAll()</TT
>, to be connected to the action your part provides.</P
><P
>The corresponding XML file for the part <TT
CLASS="literal"
>NotepadPart</TT
> is listed in <A
HREF="ch12lev1sec5.html#ch12list03"
>Listing 12.3</A
> and defines its GUI by an action named <TT
CLASS="literal"
>selectall</TT
>, to be inserted into the menu Edit in the menubar. Note that the text for the Edit menu is specified, which is mandatory even if mainwindows usually specify it, because it has to work even if a mainwindow doesn't have an Edit menu on its own. So the rule is simple: always provide a text for all menus.
			
			
			
		</P
><DIV
CLASS="example"
><HR/><A
NAME="ch12list03"
></A
><P
><B
>Example 12.3. notepadpart.rc: XML Description of the Notepad Part's User Interface
			</B
></P
><TABLE
BORDER="0"
BGCOLOR="#E0E0E0"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="programlisting"
>   1&nbsp;
   2&nbsp;&lt;!DOCTYPE kpartgui SYSTEM "kpartgui.dtd"&gt;
   3&nbsp;&lt;kpartgui name="NotepadPart" version="1"&gt;
   4&nbsp;&lt;MenuBar&gt;
   5&nbsp; &lt;Menu name="Edit"&gt;&lt;Text&gt;&amp;amp;Edit&lt;/Text&gt;
   6&nbsp;  &lt;Action name="selectall"/&gt;
   7&nbsp; &lt;/Menu&gt;
   8&nbsp;&lt;/MenuBar&gt;
   9&nbsp;&lt;StatusBar/&gt;
  10&nbsp;&lt;/kpartgui&gt;
  11&nbsp;				
  12&nbsp;				
  13&nbsp;				
  14&nbsp;				
  15&nbsp;			</PRE
></TD
></TR
></TABLE
><HR/></DIV
><P
>An important task in the definition of a part is its constructor. It must at least define the instance, the widget, the actions, and the XML File. The constructor for this example could be as shown in <A
HREF="ch12lev1sec5.html#ch12list04"
>Listing 12.4</A
>.
			
			
			
		</P
><DIV
CLASS="example"
><HR/><A
NAME="ch12list04"
></A
><P
><B
>Example 12.4. notepad_part.cpp part 1: Constructor
			</B
></P
><TABLE
BORDER="0"
BGCOLOR="#E0E0E0"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="programlisting"
>   1&nbsp;
   2&nbsp; 1: NotepadPart::NotepadPart( QWidget * parent, const char * name )
   3&nbsp; 2:  : KParts::ReadWritePart( parent, name )
   4&nbsp; 3: {
   5&nbsp; 4:   KInstance * instance = new KInstance( "notepadpart" );
   6&nbsp; 5:   setInstance( instance );
   7&nbsp; 6:
   8&nbsp; 7:   m_edit = new QMultiLineEdit( parent, "multilineedit" );
   9&nbsp; 8:   m_edit-&gt;setFocus();
  10&nbsp; 9:   setWidget( m_edit );
  11&nbsp;10:
  12&nbsp;11:   (void)new KAction( i18n( "Select All" ), 0, this,
  13&nbsp;12:         SLOT( slotSelectAll() ), actionCollection(), "selectall" );
  14&nbsp;13:   setXMLFile( "notepadpart.rc" );
  15&nbsp;14:
  16&nbsp;15:   setReadWrite( true );
  17&nbsp;16: }
  18&nbsp;				
  19&nbsp;				
  20&nbsp;				
  21&nbsp;				
  22&nbsp;			</PRE
></TD
></TR
></TABLE
><HR/></DIV
><P
>After calling the parent constructor with parent and name, you create an instance, named <TT
CLASS="literal"
>notepadpart</TT
>, and declare it to the framework using <TT
CLASS="literal"
>setInstance()</TT
>. This is a temporary solution; you'll see later how to use a library-factory's instance. Then you create the multiline edit widget, give it the focus, and declare it as well, using <TT
CLASS="literal"
>setWidget()</TT
>.</P
><P
>The next step is to create the actions that your part provides. The <SPAN
CLASS="QUOTE"
>"selectall"</SPAN
> action is given a translated label, is connected to <TT
CLASS="literal"
>slotSelectAll()</TT
>, and is created as a child of the action collection that the framework provides. This is important, because it's the only way to make it find the action later on, when parsing the XML file. This is why you don't even need to store the action in a variable, unless you want to be able to enable or disable it later.</P
><P
>You also need to give the framework the name of the XML file describing the part's GUI. As mentioned previously, it is usually installed into share/apps/instancename/, and in this case, you simply pass the filename with no path. It is also possible, but not recommended, to install the XML file anywhere else and provide a full path in <TT
CLASS="literal"
>setXMLFile()</TT
>.</P
><P
>Finally, the part is set to read/write mode. Read/write parts feature the <TT
CLASS="literal"
>setReadWrite()</TT
> call
			, which enables you to set the read/write mode on or off. Most parts should reimplement this method to enable or disable anything that modifies the part, KActions as well as any direct modification provided by the widget itself. The reimplementation of <TT
CLASS="literal"
>setReadWrite()</TT
> for the Notepad Part is shown in <A
HREF="ch12lev1sec5.html#ch12list05"
>Listing 12.5</A
>.
			
			
			
			
			
		</P
><DIV
CLASS="example"
><HR/><A
NAME="ch12list05"
></A
><P
><B
>Example 12.5. notepad_part.cpp part 2: Implementation of setReadWrite
			</B
></P
><TABLE
BORDER="0"
BGCOLOR="#E0E0E0"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="programlisting"
>   1&nbsp;
   2&nbsp;void NotepadPart::setReadWrite( bool rw )
   3&nbsp;{
   4&nbsp;  m_edit-&gt;setReadOnly( !rw );
   5&nbsp;  if (rw)
   6&nbsp;    connect( m_edit, SIGNAL( textChanged() ), this, SLOT( setModified() ) );
   7&nbsp;  else
   8&nbsp;    disconnect( m_edit, SIGNAL( textChanged() ), this, SLOT( setModified() ) );
   9&nbsp;
  10&nbsp;  ReadWritePart::setReadWrite( rw ); // always call the parent implementation
  11&nbsp;}
  12&nbsp;				
  13&nbsp;				
  14&nbsp;				
  15&nbsp;				
  16&nbsp;				
  17&nbsp;				
  18&nbsp;			</PRE
></TD
></TR
></TABLE
><HR/></DIV
><P
>In the example, there are no actions to disable, but the multiline widget has to be set to its read-only mode.</P
><P
>The connection to
			
			<TT
CLASS="literal"
>setModified()</TT
>, done in read/write mode only, enables the framework to keep track of the state of the document. When closing a document that has been modified, the framework automatically asks whether it should save it and allow you to cancel the close. Note that to make all this work, you just needed to connect a signal when the part is in read/write mode and disconnect it when it's in read-only mode. This avoids warnings when a loading a file, which changes the text.</P
><P
>It might seem a bit painful to have to handle both read/write and read-only mode, but doing this gives for free the possibility to embed the part as a viewer, in Konqueror, for instance, so it's usually worth doing.</P
><P
>Your part is created; you need to make it useful. The method that all read-only parts&#8212;and by inheritance, all read/write parts as well&#8212;must reimplement is the <TT
CLASS="literal"
>openFile()</TT
> method. This is where a part opens and displays the local file, whose full path is provided in the member variable <TT
CLASS="literal"
>m_file</TT
>, and which the framework downloaded from a remote location first, if necessary. Because your part is a text viewer, all it has to do is read the file into a <TT
CLASS="literal"
>QString</TT
> and set the multiline widget's text from it, as shown in <A
HREF="ch12lev1sec5.html#ch12list06"
>Listing 12.6</A
>.
			
			
			
			
			
		</P
><DIV
CLASS="example"
><HR/><A
NAME="ch12list06"
></A
><P
><B
>Example 12.6. notepad_part.cpp part 3: Implementation of openFile
			</B
></P
><TABLE
BORDER="0"
BGCOLOR="#E0E0E0"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="programlisting"
>   1&nbsp;
   2&nbsp; 1: bool NotepadPart::openFile()
   3&nbsp; 2: {
   4&nbsp; 3:   QFile f(m_file);
   5&nbsp; 4:   QString s;
   6&nbsp; 5:   if ( f.open(IO_ReadOnly) )
   7&nbsp; 6:   {
   8&nbsp; 7:     QTextStream t( &amp;f );
   9&nbsp; 8:     while ( !t.eof() ) {
  10&nbsp; 9:       s += t.readLine() + "\n";
  11&nbsp;10:     }
  12&nbsp;11:     f.close();
  13&nbsp;12:   }
  14&nbsp;13:   m_edit-&gt;setText(s);
  15&nbsp;14:
  16&nbsp;15:   return true;
  17&nbsp;16: }
  18&nbsp;				
  19&nbsp;				
  20&nbsp;				
  21&nbsp;				
  22&nbsp;				
  23&nbsp;				
  24&nbsp;			</PRE
></TD
></TR
></TABLE
><HR/></DIV
><P
>The last thing you need to do is, of course, to provide saving; otherwise, the user will not like it! All read/write parts have to reimplement <TT
CLASS="literal"
>saveFile()</TT
> to save the document to <TT
CLASS="literal"
>m_file</TT
>, as shown in <A
HREF="ch12lev1sec5.html#ch12list07"
>Listing 12.7</A
>. Note that the framework takes care of Save As (changing the URL to Save To), as well as uploading the saved file, if necessary.
			
			
			
			
			
		</P
><DIV
CLASS="example"
><HR/><A
NAME="ch12list07"
></A
><P
><B
>Example 12.7. notepad_part.cpp part 4: Implementation of saveFile
			</B
></P
><TABLE
BORDER="0"
BGCOLOR="#E0E0E0"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="programlisting"
>   1&nbsp;
   2&nbsp; 1: bool NotepadPart::saveFile()
   3&nbsp; 2: {
   4&nbsp; 3:   if ( !isReadWrite() )
   5&nbsp; 4:     return false;
   6&nbsp; 5:   QFile f(m_file);
   7&nbsp; 6:   QString s;
   8&nbsp; 7:   if ( f.open(IO_WriteOnly) ) {
   9&nbsp; 8:     QTextStream t( &amp;f );
  10&nbsp; 9:     t &lt;&lt; m_edit-&gt;text();
  11&nbsp;10:     f.close();
  12&nbsp;11:     return true ;
  13&nbsp;12:   } else
  14&nbsp;13:     return false;
  15&nbsp;14: }
  16&nbsp;				
  17&nbsp;				
  18&nbsp;				
  19&nbsp;				
  20&nbsp;				
  21&nbsp;				
  22&nbsp;			</PRE
></TD
></TR
></TABLE
><HR/></DIV
></TD
><TD
WIDTH="10%"
VALIGN="BOTTOM"
ALIGN="CENTER"
><ANNMARK
NAME="ch12lev1sec5"/></TD
></TR
><ANNOTATION
NAME="ch12lev1sec5"
TITLE="Creating a Part"/></TABLE
></DIV
><DIV
ALIGN="RIGHT"
CLASS="NAVBAR"
><P
><A
HREF="ch12lev1sec4.html"
>Prev</A
> <A
HREF="ch12lev1sec6.html"
>Next</A
> <A
HREF="index.html"
>Table of Contents</A
></P
></DIV
><HR
WIDTH="100%"
SIZE="2"
ALIGN="CENTER"
NOSHADE="NOSHADE"/></BODY
></HTML
>